"""
ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ
"""
import os
from collections import defaultdict
from difflib import SequenceMatcher
from dotenv import load_dotenv
from telegram import Bot
from telegram.error import TelegramError

load_dotenv()

CHANNEL_ID = os.getenv("TELEGRAM_CHANNEL_ID")


def similarity(text1: str, text2: str) -> float:
    """
    Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚ÑŒ Ğ´Ğ²ÑƒÑ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² (Ğ¾Ñ‚ 0.0 Ğ´Ğ¾ 1.0)
    """
    return SequenceMatcher(None, text1, text2).ratio()


def extract_text(message) -> str:
    """
    Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ caption Ğ´Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾)
    """
    if message.text:
        return message.text
    elif message.caption:
        return message.caption
    return ""


async def check_channel_duplicates(bot: Bot, limit: int = 100, similarity_threshold: float = 0.85):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
    
    Args:
        bot: Ğ­ĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Telegram Bot
        limit: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 100)
        similarity_threshold: ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² (0.0-1.0)
    
    Returns:
        Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÑ…
    """
    try:
        if not CHANNEL_ID:
            return {
                "error": "CHANNEL_ID Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ (.env Ñ„Ğ°Ğ¹Ğ»)"
            }
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğµ
        try:
            chat = await bot.get_chat(CHANNEL_ID)
        except TelegramError as e:
            return {
                "error": f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ°Ğ½Ğ°Ğ»Ñƒ {CHANNEL_ID}. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ°.\nĞÑˆĞ¸Ğ±ĞºĞ°: {e}"
            }
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        messages = []
        message_id = None
        
        # Telegram Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· Bot API
        # ĞÑƒĞ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¸Ğ´Ñ‚Ğ¸ Ğ½Ğ°Ğ·Ğ°Ğ´
        # ĞĞ¾ Bot API Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ Ğ² ÑÑ‚Ğ¾Ğ¼. Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ±ÑƒĞ´ĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¿ÑƒÑ‚ÑŒ:
        
        # ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´
        # Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Telethon Ğ¸Ğ»Ğ¸ Pyrogram
        
        return {
            "error": "Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»Ğ° Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ MTProto ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (Telethon/Pyrogram).\n\n"
                     "Bot API Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»Ğ°.\n\n"
                     "Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:\n"
                     "1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Telethon (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ API_ID Ğ¸ API_HASH Ğ¾Ñ‚ my.telegram.org)\n"
                     "2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Pyrogram (Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾)\n"
                     "3. ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸\n\n"
                     "Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸."
        }
        
    except Exception as e:
        return {
            "error": f"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²: {e}"
        }


async def check_duplicates_with_telethon(limit: int = 100, similarity_threshold: float = 0.85):
    """
    ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Telethon
    Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: pip install telethon
    Ğ˜ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ API_ID, API_HASH Ğ² .env
    """
    try:
        from telethon import TelegramClient
        
        api_id = os.getenv("TELEGRAM_API_ID")
        api_hash = os.getenv("TELEGRAM_API_HASH")
        bot_token = os.getenv("TELEGRAM_TOKEN")
        
        if not api_id or not api_hash:
            return {
                "error": "Ğ”Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Telethon Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² .env:\n"
                         "TELEGRAM_API_ID=your_api_id\n"
                         "TELEGRAM_API_HASH=your_api_hash\n\n"
                         "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ° https://my.telegram.org"
            }
        
        if not bot_token:
            return {
                "error": "TELEGRAM_TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ"
            }
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞµĞ¼ÑÑ ĞºĞ°Ğº Ğ±Ğ¾Ñ‚
        client = TelegramClient('bot_session', int(api_id), api_hash)
        await client.start(bot_token=bot_token)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        messages = []
        async for message in client.iter_messages(CHANNEL_ID, limit=limit):
            text = extract_text(message)
            if text:  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
                messages.append({
                    'id': message.id,
                    'text': text,
                    'date': message.date,
                    'link': f"https://t.me/{CHANNEL_ID.replace('@', '')}/{message.id}"
                })
        
        await client.disconnect()
        
        # Ğ˜Ñ‰ĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹
        duplicates = defaultdict(list)
        checked = set()
        
        for i, msg1 in enumerate(messages):
            if i in checked:
                continue
                
            group = [msg1]
            for j, msg2 in enumerate(messages[i+1:], start=i+1):
                if j in checked:
                    continue
                    
                sim = similarity(msg1['text'], msg2['text'])
                if sim >= similarity_threshold:
                    group.append(msg2)
                    checked.add(j)
            
            if len(group) > 1:
                # ĞĞ°ÑˆĞ»Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
                duplicates[msg1['id']] = group
                checked.add(i)
        
        return {
            "total_checked": len(messages),
            "duplicates_found": len(duplicates),
            "duplicate_groups": list(duplicates.values()),
            "threshold": similarity_threshold
        }
        
    except ImportError:
        return {
            "error": "Telethon Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ: pip install telethon"
        }
    except Exception as e:
        return {
            "error": f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ Ñ Telethon: {e}"
        }


def format_duplicates_report(result: dict) -> str:
    """
    Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¾ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ°Ñ… Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² Telegram
    """
    if "error" in result:
        return f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:\n\n{result['error']}"
    
    if result.get("duplicates_found", 0) == 0:
        return (
            f"âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°\n\n"
            f"ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {result['total_checked']}\n"
            f"ğŸ¯ Ğ”ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾\n"
            f"ğŸ“ ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸: {result['threshold']*100:.0f}%"
        )
    
    report = (
        f"âš ï¸ ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹!\n\n"
        f"ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {result['total_checked']}\n"
        f"ğŸ” ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²: {result['duplicates_found']}\n"
        f"ğŸ“ ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸: {result['threshold']*100:.0f}%\n\n"
    )
    
    for idx, group in enumerate(result['duplicate_groups'], 1):
        report += f"\nâ”â”â” Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° #{idx} ({len(group)} ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹) â”â”â”\n"
        
        for msg in group:
            preview = msg['text'][:100].replace('\n', ' ')
            if len(msg['text']) > 100:
                preview += "..."
            
            report += (
                f"\nğŸ“… {msg['date'].strftime('%Y-%m-%d %H:%M')}\n"
                f"ğŸ”— {msg['link']}\n"
                f"ğŸ’¬ {preview}\n"
            )
    
    return report
